apiVersion: apps/v1
kind: Deployment
metadata:
  name: clawdbot-gateway
  namespace: clawdbot
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: clawdbot-gateway
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: clawdbot-gateway
    spec:
      initContainers:
        - name: fix-permissions
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              chown -R 1000:1000 /home/node/.clawdbot
              chown -R 1000:1000 /home/node/clawd
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: config
              mountPath: /home/node/.clawdbot
            - name: workspace
              mountPath: /home/node/clawd
      containers:
        - name: clawdbot-gateway
          image: ghcr.io/arjansiemons/clawdbot:latest
          imagePullPolicy: Always
          command:
            - sleep
            - infinity
          # ORIGINAL COMMAND (uncomment when fixed):
          # command:
          #   - node
          #   - dist/index.js
          #   - gateway-daemon
          #   - --bind
          #   - lan
          #   - --port
          #   - "18789"
          ports:
            - name: gateway
              containerPort: 18789
              protocol: TCP
            - name: bridge
              containerPort: 18790
              protocol: TCP
          env:
            - name: HOME
              value: /home/node
            - name: NODE_ENV
              value: production
            - name: CLAWDBOT_GATEWAY_TOKEN
              valueFrom:
                secretKeyRef:
                  name: clawdbot-gateway-token
                  key: CLAWDBOT_GATEWAY_TOKEN
          resources:
            limits:
              cpu: "1"
              memory: 1Gi
            requests:
              cpu: 250m
              memory: 512Mi
          volumeMounts:
            - name: config
              mountPath: /home/node/.clawdbot
            - name: workspace
              mountPath: /home/node/clawd
          livenessProbe:
            httpGet:
              path: /health
              port: gateway
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: gateway
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsUser: 1000
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: clawdbot-config
        - name: workspace
          persistentVolumeClaim:
            claimName: clawdbot-workspace
